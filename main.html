<!-- git pull |  git add .  && git commit -m "someMessage" && git push origin master -->
<!DOCTYPE html>
<meta charset="utf-8"/>
<html>
  <head>

    <!-- SCRIPTS -->
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.min.js"></script>

    <script type="text/javascript" src="draggable.js"></script>
    <script type="text/javascript" src="masterDataControl.js"></script>
    
    <!-- BOOTSTRAP -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- DRAGGABLE STYLESHEET-->
    <link rel="stylesheet" type="text/css" href="draggable.css">

    <style>
      .headerDiv { grid-area: header; }
      .leftPannel { grid-area: menu; }
      .upperPannel { grid-area: upperPannel; }
      .mainPannel { grid-area: main; height:550px;}

      .grid-container {
        display: grid;
        grid-template-areas:
          'header header header header header header'
          'menu upperPannel upperPannel upperPannel upperPannel upperPannel'
          'menu main main main main main'
          'menu footer footer footer footer footer';
        grid-gap: 10px;
        background-color: #dbdbdb;
        padding: 10px;
      }

      .grid-container > div {
        background-color: rgba(255, 255, 255, 0.8);
        text-align: center;
        padding: 20px 0;
        font-size: 30px;
      }
    </style>

    <!-- MODAL STYLE-->
    <style>
    /* The Modal (background) */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 10; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
        color:white;
      }

      /* Modal Content */
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      /* The Close Button */
      .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }
      </style>

</head>

<body>

<!-- SPLASH -->

<!-- -->

<!-- MAIN -->
  <div class="grid-container">
    <div class="headerDiv">
      MODEL CONSTRUCT
    </div>
    
    <div class="leftPannel">
      
      <div class="loadData">
        <button class="dataLoadButton" >Load Master Data</button>
      </div>

      <div class="objectsShowList">
      </div>

    </div>
    
    <div class="upperPannel">
        <div class="upperPannelContent" style="display:none">
          <button class="dataSaveButton" >Save Master Data</button>
          <button class="objectCreateButton" >Create New Object</button>
        </div>
    </div>  
    
    <div class="mainPannel">
      <div class="canvasContainer">
      </div>  
    </div>
  
  </div>
<!-- -->

<!-- MODAL -->
<div id="myModal" class="modal">

  <div class="modalContent">
    
  </div>

</div>


<a id="downloadLink" style="display:none" >  </a>
<input type="file" id="fileInput" name="files[]" style="display:none" />

</body>

<script>

  

  $("#fileInput").change(function() {
    var file = $("#fileInput")[0].files[0];
    var reader = new FileReader();
    reader.onload = function(e) {  loadMaster(e.target.result); };
    reader.readAsText(file);
  });

  $(".dataLoadButton").on("click", function() {
    $("#fileInput").trigger("click");
  });

  $(".dataSaveButton").on("click", function() {
    saveMaster();
  });

  $( this ).on( "masterDataLoaded", function() {
    onMasterDataLoaded();
  });

  
  function objectSelected(isChecked , objectId){
    if(isChecked){
      addObjectToCanvas(objectId)
    }else{
      removeObjectFromCanvas(objectId);
    }
  }

  function onMasterDataLoaded(){
    $('.loadData')[0].style = 'display:none';
    $('.upperPannelContent')[0].style = 'display:block';
    fillObjectsList();
  }

  function fillObjectsList(){
    var strList = '<div class="panel panel-default">';
    strList +=    '   <div class="panel-heading">Objects</div>';
    strList +=    '   <div class="panel-body">';
    strList +=    '    <ul>';
    for(var i = 0 ; i < master.lastID + 1 ; i++){
      //console.log(master.objects[i].name);
      strList +=  '     <li><input type="checkbox" class="showObjCheckbox" onclick="objectSelected(this.checked , '+master.objects[i].id+')" ></input>'+master.objects[i].name+'</li>';
    }
    strList +=    '   </ul>';
    strList +=    '  </div>';
    strList +=    '</div>';
    $('.objectsShowList')[0].innerHTML = strList;
  }

  function addObjectToCanvas(objectId){
    minDragX = 374;
    maxDragX = 1056;  
    
    minDragY = 200;
    maxDragY = 430;

    var strObj = '';
    strObj += '<div id="draggableDiv_'+objectId+'" class="dragObjDiv" >';
    
    strObj += getDraggaleDivHtmlFor(objectId);

    strObj += '</div>';
    $('.canvasContainer')[0].innerHTML += strObj;
    dragElement(document.getElementById("draggableDiv_"+objectId)); 
  }

  function getDraggaleDivHtmlFor(objectId){
    var objectProperties = getPropertiesFromMasterDataFor(objectId);
    var objectMethods = getMethodsFromMasterDataFor(objectId);

    var strObj = '   <div class="dragObjHeader" ><span style="cursor: pointer" class="glyphicon glyphicon-fast-backward" onclick="doRestore(\''+objectId+'\')">    '+getObjectNameFromMasterDataFor(objectId)+'</div>';
    strObj += '   <div class="dragObjSubHeader" > Properties  <span style="cursor: cell" class="glyphicon glyphicon-plus"></span> </div>';
    
    if(objectProperties.length > 0 ){
      strObj += '   <div>';
      strObj += '   <ul>';
      for(var i = 0 ; i < objectProperties.length ; i++){
        strObj += '<ul>  ('+objectProperties[i].type+') '+objectProperties[i].name+'  <span style="cursor: pointer" class="glyphicon glyphicon-edit" onclick="openEditProperty( \''+objectId+'\' ,  \''+objectProperties[i].name+'\' , \''+objectProperties[i].type+'\' )" ></span>  <span style="cursor: pointer" class="glyphicon glyphicon-trash" onclick="removePropertyFromObject( \''+objectId+'\' , \''+objectProperties[i].type+'\' , \''+objectProperties[i].name+'\')" ></span> </ul>';
      }
      strObj += '   </div>';
    }

    strObj += '   <div class="dragObjSubHeader" >   Methods   <span style="cursor: cell" class="glyphicon glyphicon-plus"></span>  </div>';

    if(objectMethods.length > 0 ){
      strObj += '   <div>';
      strObj += '   <ul>';
      for(var i = 0 ; i < objectMethods.length ; i++){
        strObj += '<ul>'+objectMethods[i].name+'  <span style="cursor:pointer" class="glyphicon glyphicon-edit" onclick="openEditMethod( \''+objectId+'\' ,  \''+objectMethods[i].name+'\'  , '+JSON.stringify(objectMethods[i].params)+' )" ></span>  <span style="cursor:pointer" class="glyphicon glyphicon-trash" onclick="removeMethodFromObject( \''+objectId+'\'  , \''+objectMethods[i].name+'\' )" ></span>  </ul>';
      }
      strObj += '   </div>';
    }

    return strObj;
  }

  function removeObjectFromCanvas(objectId){
    var element = document.getElementById("draggableDiv_"+objectId);
    element.parentNode.removeChild(element); 
  }


  function addPropertyToObject(objectId , propertyType , propertyName){
    addPropertyToMasterData(objectId , propertyType , propertyName);
    document.getElementById("draggableDiv_"+objectId).innerHTML = getDraggaleDivHtmlFor(objectId); 
  }


  function removePropertyFromObject(objectId , propertyType , propertyName){
    removePropertyFromMasterData(objectId , propertyType , propertyName);
    document.getElementById("draggableDiv_"+objectId).innerHTML = getDraggaleDivHtmlFor(objectId); 
  }

  function addMethodToObject(objectId , methodName , parameters){
    addMethodToMasterData(objectId , methodName , parameters);
    document.getElementById("draggableDiv_"+objectId).innerHTML = getDraggaleDivHtmlFor(objectId); 
  }


  function removeMethodFromObject(objectId , methodName ){
    removeMethodFromMasterData(objectId , methodName );
    document.getElementById("draggableDiv_"+objectId).innerHTML = getDraggaleDivHtmlFor(objectId); 
  }

  function doRestore(objectId){
    restoreObjectToOriginal(objectId);
    document.getElementById("draggableDiv_"+objectId).innerHTML = getDraggaleDivHtmlFor(objectId);  
  }



  var objectEditing;
  var oldPropertyType;
  var oldPropertyName;

  var oldMethodName;
  var newMethodParams;

  
  var newName;

  function openEditProperty( objectId , objectPropertyName , objectPropertyType ){
    
    objectEditing = objectId;
    oldPropertyType = objectPropertyType;
    oldPropertyName = objectPropertyName;
    fillModalForPropertyEdition( objectId , objectPropertyName , objectPropertyType );
    document.getElementById("myModal").style.display = "block";


  }

  function fillModalForPropertyEdition(objectid , propertyName , propertyType ){
    var modalContent =  '   <div class="modal-header">';
    modalContent     += '     <h4 class="modal-title">Edit <b>'+propertyName+'</b> Property  </h4>';
    modalContent     += '   </div> ';
    
    modalContent     += '   <div class="modal-body">';
    
    modalContent     += '   Property Type:';
    modalContent     += '   <select id="editPropertyType" style="color:black" " >';
    modalContent     += '     <option value="int">int</option>';
    modalContent     += '     <option value="string">string</option>';
    modalContent     += '   </select>';
    //modalContent     += '     Property Type: <input id="editPropertyType"   style="color:black" value="'+propertyType+'"  type="string" ></input>';
    

    modalContent     += '     <span style="padding-left: 5px;" >';
    modalContent     += '       Property Name: <input id="editPropertyName" style="color:black" value="'+propertyName+'"  type="string" ></input>';
    modalContent     += '     </span>';
    modalContent     += '   </div>';

    modalContent     += '   <div class="modal-footer">';
    modalContent     += '     <div id="propertyEditAlert" style="color:red" ></div>';
    modalContent     += '     <button onclick="acceptProeprtyEdit()" type="button" class="btn btn-default" data-dismiss="modal">Accept</button>';
    modalContent     += '     <button onclick="closeModal()"  type="button" class="btn btn-default" data-dismiss="modal">Close</button>';
    modalContent     += '   </div>';

    document.getElementById("myModal").innerHTML = modalContent;
    $('#editPropertyType').val(propertyType);
  }

  function acceptProeprtyEdit(){
    var valid = true;
    var newName = $('#editPropertyName').val();
    var newType = $('#editPropertyType').val();
    var objectProperties = getPropertiesFromMasterDataFor(objectEditing);
    for(var i = 0; i < objectProperties.length ; i++){
      if( objectProperties[i].name != oldPropertyName && objectProperties[i].type != oldPropertyType  && objectProperties[i].name == newName && objectProperties[i].type == newType ){
        valid = false;
      }
    }

    if(valid){
      updatePropertyFromMasterData(objectEditing , oldPropertyType , oldPropertyName , newType , newName);
      document.getElementById("draggableDiv_"+objectEditing).innerHTML = getDraggaleDivHtmlFor(objectEditing);
      closeModal();
    }else{
      $('#propertyEditAlert')[0].innerHTML = 'The property values already exist.';
    }

  }

  function openEditMethod( objectId , objectMethodName , params ){
    objectEditing = objectId;
    oldMethodName = objectMethodName;
    newMethodParams = params;
    
    fillModalForMethodEdition( objectId , objectMethodName , params );
    document.getElementById("myModal").style.display = "block";
  }


  function fillModalForMethodEdition(objectid , methodName , methodParams ){
    
    var modalContent =  '   <div class="modal-header">';
    modalContent     += '     <h4 class="modal-title">Edit <b>'+methodName+'</b> Method</h4>';
    modalContent     += '   </div> ';
    
    modalContent     += '   <div class="modal-body">';
    
    modalContent     += '     <span style="padding-left: 5px;" >';
    modalContent     += '       Property Name: <input id="editMethodName" style="color:black" value="'+methodName+'"  type="string" ></input>';
    modalContent     += '     </span>';
    
    //modalContent     += ''
    modalContent     += '<br/>Parameters: ';
    modalContent     += '   <span style="cursor:pointer" class="glyphicon glyphicon-plus" onclick="showNewParamSection()" ></span> ';
    modalContent     += '   <div id="newParamSection" style="display:none">';
    modalContent     += '     <input id="newParamInput" style="color:black" type="text"/>';
    modalContent     += '     <span style="cursor:pointer" class="glyphicon glyphicon-ok-sign"      onclick="addParamForMethod()" ></span>';
    modalContent     += '     <span style="cursor:pointer" class="glyphicon glyphicon-remove-sign"  onclick="hideNewParamSection()" ></span>';
    modalContent     += '     <div id="newParamErrorMessage" style="color:red" ></div>';
    modalContent     += '   </div>';
    modalContent     += '<div style="background-color:white;min-height:20px;">';
    modalContent     += '<ul id="methodEditParamsList" style="color:black" >';
    modalContent     += getParamListInnerHtml(methodParams);
    modalContent     += '</ul> ';
    modalContent     += '</div>';

    modalContent     += '   </div>';

    modalContent     += '   <div class="modal-footer">';
    modalContent     += '     <div id="methodEditAlert" style="color:red" ></div>';
    modalContent     += '     <button onclick="acceptMethodEdit()" type="button" class="btn btn-default" data-dismiss="modal">Accept</button>';
    modalContent     += '     <button onclick="closeModal()"  type="button" class="btn btn-default" data-dismiss="modal">Close</button>';
    modalContent     += '   </div>';

    document.getElementById("myModal").innerHTML = modalContent;
    
  }

  function showNewParamSection(){
    $('#newParamSection')[0].style.display = 'block';
    $('#newParamErrorMessage')[0],innerHTML = '';
  }

  function hideNewParamSection(){
    $('#newParamSection')[0].style.display = 'none';
  }

  function addParamForMethod(){
    var newParamName = $('#newParamInput').val();
    if(newParamName != undefined && newParamName != null && newParamName != ''){
      var valid = true;
      for(var i = 0; i < newMethodParams.length; i++){
        if(newMethodParams[i] == newParamName){
          valid = false;
        }
      }

      if(valid){
        newMethodParams.push(newParamName);
        $('#methodEditParamsList')[0].innerHTML = getParamListInnerHtml(newMethodParams);
      }else{
        $('#newParamErrorMessage')[0],innerHTML = 'Cannot add repeated parameter';
      }

    }
    //objectEditing
    //oldMethodName
    //newMethodParams
  }

  function removeParamFromMethodEditList(aparaName){
    newMethodParams.splice( newMethodParams.indexOf('aparaName'), 1 );
    $('#methodEditParamsList')[0].innerHTML = getParamListInnerHtml(newMethodParams);
  }

  function getParamListInnerHtml(aParamsList){
    var result = '';
    for(var i = 0; i < aParamsList.length ; i++){
      result += '<li style="display:inline;border-radius: 20px;border: 1px solid;" ><span style="cursor:pointer" class="glyphicon glyphicon-remove" onclick="removeParamFromMethodEditList(\''+aParamsList[i]+'\')" >'+aParamsList[i]+'</li>';
    }
    return result;
  }

  function acceptMethodEdit(){
    var valid = true;
    var newName = $('#editMethodName').val();
    
    var objectMethods = getMethodsFromMasterDataFor(objectEditing);

    for(var i = 0; i < objectMethods.length ; i++){
      if( objectMethods[i].name != oldMethodName && objectProperties[i].name == newName ){
        valid = false;
      }
    }

    if(valid){
      updateMethodFromMasterData(objectEditing , oldMethodName , newName , []);
      document.getElementById("draggableDiv_"+objectEditing).innerHTML = getDraggaleDivHtmlFor(objectEditing);
      closeModal();
    }else{
      $('#propertyEditAlert')[0].innerHTML = 'The property values already exist.';
    }
    
  }


  function fillModalForNameEdition(objectid ){

  }

  function closeModal(){
    document.getElementById("myModal").style.display = "none";
  }

  /*
  //CLOSE MODAL ON CLICK OUTSIDE
  window.onclick = function(event) {
    if (event.target == document.getElementById("myModal")) {
      document.getElementById("myModal").style.display = "none";
    }
  }
  */

</script>

</html>
